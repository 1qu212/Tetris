@[TOC](经典俄罗斯方块Android版)

# 缘起
在GitHub上看到[react-tetris](https://github.com/chvin/react-tetris)版本的俄罗斯方块，长这样的：![](./screenshot/tetris_01.gif)

好炫，我也要做一个，心里产生了这样的想法。然后就有了[经典俄罗斯方块（Android版）](https://github.com/1qu212/Tetris)。
项目地址:[https://github.com/1qu212/Tetris](https://github.com/1qu212/Tetris)。
## 界面设计
界面使用**GridView**的想法来自[Android使用GridView实现简单的俄罗斯方块](https://github.com/weijifen/AndroidTetris)。
左侧界面和右侧下一个方块片使用的是**GridView**；每一个方格是使用**selector**做的；分数、等级、最高分的数字显示使用了**特定字体**；按键则使用了**selector**；游戏结束的动画使用了[react-tetris](https://github.com/chvin/react-tetris)中的图片，使用美图秀秀裁成需要的四张图片，合成了一个**帧动画**。


## 方块片的设计
使用**数组**来代表方块片的每一个值（明或暗），方块片类**Piece**提供了**长度为16的数组**代表一个4x4的方块片，也提供了**长度为8的数组**代表一个4x2的方块片。方块片旋转后的形状是有限的，这样也就可以使用有限的数组来代表方块片。Piece提供了一个随机的初始状态及代表该状态下方块片的数组（方块片的初始状态必然是能代表4x2方块片的一种状态）。Piece还提供了获取下一个状态数组、上一个状态数组的方法，这为后面方块片旋转做的工作；还提供了方块片在界面中刚下落时方块片左下角在界面中的位置。
提供了一个**PieceFatory**类来随机生成方块片。


## 游戏初始化
会进行一些赋值，界面显示，会从**SharedPreferences**中获取一些需要展示的数据。


## 自动下落的处理
自动下落使用了一个Timer定时器**执行定时任务**来完成，这个定时任务就是与down按钮一样发送DOWN指令。


## 按钮点击事件的处理
按钮点击事件就是通过发送各自的**指令**交给**handler**处理。


## 可能多个指令同时发送的处理
我采用了**HandlerThread+Handler**的方案，这样单子线程处理，在未执行完一个指令之前不会执行下一个指令。使用子线程的原因，一是需要处理计算，更重要的是后面处理消除行动画以及重玩动画需要Thread.sleep()。当然后面界面的显示以及右侧下一个方块片的显示，都是发送指令到**UI线程中的Handler**处理。


## REFRESH_BLOCK_BOARD指令：方块片在左侧界面中显示
左侧界面也是一个数组，方块片也是一个数组，把方块片的数组元素赋值给界面数组中对应位置上代表空白的数组元素，然后更新界面显示。


## UP、LEFT、RIGHT指令
向上就是改变方块片的状态，调用Piece提供的方法；向左就是方块片左下角在界面中的列数减一；向右就是方块片左下角在界面中的列数加一。执行指令后可能方块片可能会与界面相撞，如果相撞则恢复原来位置；如果不相撞，则更新界面显示。


## 什么代表相撞，什么代表不相撞
界面空白处有方块片的四个亮方块，则代表不相撞；
方块片左下角在界面中的行数小于等于方块片左下角在界面中的初始行数，则代表不相撞（这里需要小于初始行数，是因为后面方块片在界面中初始化时实际是从==初始行数减一==开始的，这又是因为初始化后收到一个DOWN指令才开始在界面中显示，如果不减一视觉上方块片会从界面的第二行开始显示，发送指令后才显示是因为显示前都要进行相撞检测）。

如果界面亮方块处，也有方块片的亮方块，则代表相撞；
除以上情况，其他情况也代表相撞。

另外，如果界面亮方块处相撞的行数小于等于方块片在界面中初始化时的行数，则代表游戏结束，这里==游戏结束时返回不相撞==是为了防止游戏结束还在检测是否触底，以及其带来的右侧方块片的刷新。


## DOWN指令的设计
有三种情况都会发送DOWN指令，一自由下落，二按向下按钮下落，三按掉落按钮下落。按掉落按钮会使用一个**Timer**定时器来快速定时发送DOWN指令。

当下落时相撞，则代表着触底。触底后需要处理消除满行，以及更新分数，更新下一个方块片。


## 消除满行
如果一行中有列数个亮方块，则这行满了，需要消除。这里消除动画采用了将这一行忽明忽暗显示。每多消除一个满行，每行消除增加的分数会多20。一次消除任务执行后，每行消除增加的分数又变回100。


## 右侧“下一个”方块片的显示
右侧方块片是使用的4x2的数组，每当“下一个”更新的时候，会把其4x4数组的形式赋值给显示在左侧界面中的方块片。


## PAUSE_RESUME、PAUSE、RESUME指令
这几个指令发出后，上下左右掉落几个按钮会在**disenable**和**enable**状态间切换，以及定时器的暂停、新建的切换。

以下几种情况都需要发送这几个指令：
点击暂停按钮后；
点击重玩按钮后；
处理方块片触底时。


## RESTART指令
点击重玩按钮会发送RESTART指令，定时器会暂停，左侧界面会从下至上变亮，再从上至下变暗，然后初始化一些数据并新建定时器。


## 游戏结束
游戏结束，暂停计时器，展示一个帧动画，然后使用**SharedPreferences**保存一些游戏数据。
